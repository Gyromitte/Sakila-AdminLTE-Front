<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" type="image/x-icon" href="dist/img/favicon.ico" />

    <title>Sakila Films</title>
    <!-- Google Font: Source Sans Pro -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css" />
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/adminlte.min.css" />
  </head>
  <body class="hold-transition sidebar-mini dark-mode">
    <div class="wrapper">
      <!-- Navbar -->
      <nav class="main-header navbar navbar-expand navbar-dark navbar-light">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"
              ><i class="fas fa-bars"></i
            ></a>
          </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
          <!-- Navbar Search -->
          <li class="nav-item">
            <div class="navbar-search-block">
              <form class="form-inline">
                <div class="input-group input-group-sm">
                  <input
                    class="form-control form-control-navbar"
                    type="search"
                    placeholder="Search"
                    aria-label="Search"
                  />
                  <div class="input-group-append">
                    <button class="btn btn-navbar" type="submit">
                      <i class="fas fa-search"></i>
                    </button>
                    <button
                      class="btn btn-navbar"
                      type="button"
                      data-widget="navbar-search"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </li>

          <li class="nav-item">
            <a class="nav-link" data-widget="fullscreen" href="#" role="button">
              <i class="fas fa-expand-arrows-alt"></i>
            </a>
          </li>
        </ul>
      </nav>
      <!-- /.navbar -->

      <!-- Main Sidebar Container -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="index3.html" class="brand-link">
          <img
            src="dist/img/favicon.ico"
            alt="Sakila Films Logo"
            class="brand-image"
            style="opacity: 0.8"
          />
          <span class="brand-text font-weight-light">Sakila Films</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- Sidebar user panel (optional) -->
          <div class="user-panel mt-3 pb-3 mb-3 d-flex">
            <div class="image">
              <img
                src="dist/img/user2-160x160.jpg"
                class="img-circle elevation-2"
                alt="User Image"
              />
            </div>
            <div class="info">
              <a href="#" class="d-block">User Name</a>
            </div>
          </div>

          <!-- SidebarSearch Form -->
          <div class="form-inline">
            <div class="input-group" data-widget="sidebar-search">
              <input
                class="form-control form-control-sidebar"
                type="search"
                placeholder="Search"
                aria-label="Search"
              />
              <div class="input-group-append">
                <button class="btn btn-sidebar">
                  <i class="fas fa-search fa-fw"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Sidebar Menu -->
          <nav class="mt-2">
            <ul
              class="nav nav-pills nav-sidebar flex-column"
              data-widget="treeview"
              role="menu"
              data-accordion="false"
            >
              <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
              <!--MOVIES-->
              <li class="nav-item menu">
                <a href="movies.html" class="nav-link">
                  <i class="nav-icon fas fa-film"></i>
                  <p>Películas</p>
                </a>
              </li>

              <!--ACTORS-->
              <li class="nav-item">
                <a href="actors.html" class="nav-link">
                  <i class="nav-icon fas fa-mask"></i>
                  <p>Actores</p>
                </a>
              </li>

              <!--CLIENTS-->
              <li class="nav-item">
                <a href="clients.html" class="nav-link">
                  <i class="nav-icon fas fa-users"></i>
                  <p>Clientes</p>
                </a>
              </li>

              <!--RENTALS-->
              <li class="nav-item">
                <a href="rentals.html" class="nav-link">
                  <i class="nav-icon fas fa-money-bill"></i>
                  <p>Rentas</p>
                </a>
              </li>

              <!--INVENTORY-->
              <li class="nav-item">
                <a href="inventory.html" class="nav-link">
                  <i class="nav-icon fas fa-box"></i>
                  <p>Inventario</p>
                </a>
              </li>

              <!--STAFF-->
              <li class="nav-item">
                <a href="staff.html" class="nav-link">
                  <i class="nav-icon fas fa-people-arrows"></i>
                  <p>Staff</p>
                </a>
              </li>

              <!--STORES-->
              <li class="nav-item">
                <a href="store.html" class="nav-link active">
                  <i class="nav-icon fas fa-store"></i>
                  <p>Tiendas</p>
                </a>
              </li>
            </ul>
          </nav>
          <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
      </aside>

      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1 class="m-0">Home</h1>
              </div>
              <!-- /.col -->
              <div class="col-sm-6"></div>
              <!-- /.col -->
            </div>
            <!-- /.row -->
          </div>
          <!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <div class="content">
          <div class="container-fluid">
            <!-- Botón para abrir el modal -->
            <div class="row mb-3">
              <div class="col-lg-12">
                <button
                  class="btn btn-primary"
                  data-toggle="modal"
                  data-target="#storeModal"
                >
                  Agregar Tienda
                </button>
              </div>
            </div>

            <!-- Tabla para listar tiendas -->
            <div class="row">
              <div class="col-lg-12">
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Lista de Tiendas</h3>
                  </div>
                  <div class="card-body">
                    <table
                      id="storesTable"
                      class="table table-bordered table-striped"
                    >
                      <thead>
                        <tr>
                          <th>ID de Tienda</th>
                          <th>ID del Gerente</th>
                          <th>ID de Dirección</th>
                          <th>Última Actualización</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Contenido dinámico -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.row -->
          </div>
          <!-- /.container-fluid -->
        </div>
        <!-- /.content -->
      </div>
      <!-- /.content-wrapper -->

      <!-- Modal para agregar/editar tiendas -->
      <div
        class="modal fade"
        id="storeModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="storeModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="storeModalLabel">
                Agregar/Actualizar Tienda
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="storeForm">
                <input type="hidden" id="store_id" />
                <div class="form-group">
                  <label for="manager_staff_id">ID del Gerente</label>
                  <input
                    type="number"
                    class="form-control"
                    id="manager_staff_id"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="address_id">ID de Dirección</label>
                  <input
                    type="number"
                    class="form-control"
                    id="address_id"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary">Guardar</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Control Sidebar -->
      <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
        <div class="p-3">
          <h5>Title</h5>
          <p>Sidebar content</p>
        </div>
      </aside>
      <!-- /.control-sidebar -->
    </div>
    <!-- ./wrapper -->

    <!-- REQUIRED SCRIPTS -->

    <!-- jQuery -->
    <script src="plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="dist/js/adminlte.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetchStores();

        document
          .getElementById("storeForm")
          .addEventListener("submit", function (event) {
            event.preventDefault();
            const storeId = document.getElementById("store_id").value;
            if (storeId) {
              updateStore(storeId);
            } else {
              const managerStaffId = parseInt(
                document.getElementById("manager_staff_id").value
              );
              const addressId = parseInt(
                document.getElementById("address_id").value
              );
              const body = {
                manager_staff_id: managerStaffId,
                address_id: addressId,
              };
              addStore(body);
            }
          });

        document
          .querySelector("#storesTable")
          .addEventListener("click", function (event) {
            if (event.target.closest(".editStore")) {
              const storeId = event.target.closest(".editStore").dataset.id;
              editStore(storeId);
            } else if (event.target.closest(".deleteStore")) {
              const storeId = event.target.closest(".deleteStore").dataset.id;
              deleteStore(storeId);
            }
          });
      });

      function fetchStores() {
        fetch("http://143.110.198.189/api/stores")
          .then((response) => response.json())
          .then((data) => {
            const tbody = document.querySelector("#storesTable tbody");
            tbody.innerHTML = "";
            data.forEach((store) => {
              const row = document.createElement("tr");
              row.innerHTML = `
            <td>${store.store_id}</td>
            <td>${store.manager_staff_id}</td>
            <td>${store.address_id}</td>
            <td>${store.last_update}</td>
            <td>
              <button class="btn btn-sm btn-smaller editStore" data-id="${store.store_id}">
                <i class="fas fa-pencil-alt text-light"></i>
              </button>
              <button class="btn btn-sm btn-smaller deleteStore" data-id="${store.store_id}">
                <i class="fas fa-trash text-danger"></i>
              </button>
            </td>
          `;
              tbody.appendChild(row);
            });
          });
      }

      function addStore(body) {
        const managerStaffId =
          document.getElementById("manager_staff_id").value;
        const addressId = document.getElementById("address_id").value;
        console.log("method post, body", body);

        fetch("http://143.110.198.189/api/stores", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify(body),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((error) => {
                throw new Error(error.message);
              });
            }
            return response.json();
          })
          .then((data) => {
            fetchStores();
            document.getElementById("storeForm").reset();
            $("#storeModal").modal("hide");
          })
          .catch((error) => {
            console.error("Error:", error);
            if (error.message.includes("SQLSTATE")) {
              alert(
                "Error: El ID del gerente ya está en uso. Por favor, elige otro."
              );
            } else {
              alert(`Error: ${error.message}`);
            }
          });
      }

      function editStore(storeId) {
        fetch(`http://143.110.198.189/api/stores/${storeId}`)
          .then((response) => response.json())
          .then((store) => {
            document.getElementById("store_id").value = store.store_id;
            document.getElementById("manager_staff_id").value =
              store.manager_staff_id;
            document.getElementById("address_id").value = store.address_id;
            $("#storeModal").modal("show");
          });
      }

      function updateStore(storeId) {
  const managerStaffId = parseInt(
    document.getElementById("manager_staff_id").value
  );
  const addressId = parseInt(document.getElementById("address_id").value);
  console.log("method put");

  fetch(`http://143.110.198.189/api/stores/${storeId}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Accept: "application/json",
    },
    body: JSON.stringify({
      manager_staff_id: managerStaffId,
      address_id: addressId,
    }),
  })
    .then((response) => {
      if (!response.ok) {
        return response.json().then((error) => {
          throw new Error(error.message);
        });
      }
      return response.json();
    })
    .then((data) => {
      fetchStores();
      document.getElementById("storeForm").reset();
      $("#storeModal").modal("hide");
    })
    .catch((error) => {
      console.error("Error:", error);
      alert(`Error: ${error.message}`);
    });
}

      function deleteStore(storeId) {
        fetch(`http://143.110.198.189/api/stores/${storeId}`, {
          method: "DELETE",
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((error) => {
                throw new Error(error.message);
              });
            }
            return response.json();
          })
          .then((data) => {
            fetchStores();
          })
          .catch((error) => {
            console.error("Error:", error);
            alert(
              `Error: no puedes eliminar esta tienda hasta que no elimines las rentas asociadas a ella.`
            );
          });
      }
    </script>
  </body>
</html>
